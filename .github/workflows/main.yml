name: MobScan Security Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
  workflow_dispatch:
    inputs:
      profile:
        description: 'Scan profile to use'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - financial

env:
  # Set scan profile: 'baseline' for standard apps, 'financial' for banking/payment apps
  # Can be overridden via workflow_dispatch
  SCAN_PROFILE: ${{ github.event.inputs.profile || 'baseline' }}

jobs:
  security-scan:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install MobScan
        run: |
          pip install semgrep
          pip install git+https://${{ secrets.GH_PAT }}@github.com/XavLimSG/MobScan.git

      - name: List available profiles
        run: |
          mobscan profiles

      - name: Run MobScan with Compliance Mapping
        run: |
          mobscan scan . \
            --profile ${{ env.SCAN_PROFILE }} \
            --format sarif \
            --output mobscan.sarif \
            --show-compliance \
            --fail-on none
        continue-on-error: true

      - name: Generate Compliance Report (Text)
        run: |
          mobscan compliance-report . \
            --profile ${{ env.SCAN_PROFILE }} \
            --format text \
            --output compliance-report.txt || echo "Compliance report generation completed with findings"
        continue-on-error: true

      - name: Generate Compliance Report (HTML)
        run: |
          mobscan compliance-report . \
            --profile ${{ env.SCAN_PROFILE }} \
            --format html \
            --output compliance-report.html || echo "HTML report generation completed with findings"
        continue-on-error: true

      - name: Generate JSON Report with Compliance
        run: |
          mobscan scan . \
            --profile ${{ env.SCAN_PROFILE }} \
            --format json \
            --output mobscan-compliance.json \
            --fail-on none
        continue-on-error: true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        continue-on-error: true
        with:
          sarif_file: mobscan.sarif
          category: mobscan-security

      - name: Upload Compliance Reports as Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mobscan-${{ env.SCAN_PROFILE }}-reports
          path: |
            compliance-report.txt
            compliance-report.html
            mobscan-compliance.json
            mobscan.sarif
          retention-days: ${{ env.SCAN_PROFILE == 'financial' && 365 || 90 }}

      - name: Display Compliance Summary
        if: always()
        run: |
          echo "==================================================================="
          echo "COMPLIANCE SCAN SUMMARY"
          echo "==================================================================="
          echo "Profile: ${{ env.SCAN_PROFILE }}"
          if [ "${{ env.SCAN_PROFILE }}" == "baseline" ]; then
            echo "Standards: CSA SAS 2.0, OWASP MASVS 2.1"
            echo "Retention: 90 days"
          else
            echo "Standards: CSA SAS 2.0, OWASP MASVS 2.1, MAS TRM"
            echo "Retention: 365 days (audit compliance)"
          fi
          echo ""
          cat compliance-report.txt || echo "No compliance report generated"
          echo "==================================================================="

      - name: Comment PR with Compliance Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            let reportText = 'Compliance report not generated';
            try {
              reportText = fs.readFileSync('compliance-report.txt', 'utf8');
            } catch (e) {
              console.log('Could not read compliance report');
            }

            const profile = '${{ env.SCAN_PROFILE }}';
            const standards = profile === 'financial'
              ? 'CSA SAS 2.0, OWASP MASVS 2.1, MAS TRM'
              : 'CSA SAS 2.0, OWASP MASVS 2.1';

            const emoji = profile === 'financial' ? 'üè¶' : 'üîí';
            const profileName = profile === 'financial'
              ? 'Financial (Banking/Payment Apps)'
              : 'Baseline (Standard Apps)';

            const comment = `## ${emoji} MobScan Security Scan Results

            **Profile**: ${profileName}
            **Standards**: ${standards}

            <details>
            <summary>üìã View Compliance Report</summary>

            \`\`\`
            ${reportText.substring(0, 60000)}
            \`\`\`

            </details>

            **üìä Artifacts**: Download full reports (text, HTML, JSON, SARIF) from workflow run artifacts.

            **‚ÑπÔ∏è Note**: This scan does not block PRs. Review findings and address as needed.

            ---
            _Powered by MobScan v0.1.0_`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Display Security Summary
        if: always()
        run: |
          echo "==================================================================="
          echo "Security scan completed. Review findings above and in artifacts."
          echo "This workflow will not fail the build regardless of severity."
          echo "==================================================================="
